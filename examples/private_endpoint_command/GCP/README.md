# Capella GCP Command Example

This example shows how to retrieve the GCP command used to configure a Private Endpoint for a Couchbase Capella cluster.

To run, configure your Couchbase Capella Terraform provider as described in the [README](../../../README.md) in the root of this project.

---

## Example Walkthrough

In this example, we are going to:

1. Use Terraform to retrieve the GCP command generated by Capella.
2. View the command in the output of `terraform apply`.

---

## GET

Command:

```bash
terraform apply
```

Sample Output:

```
terraform apply
╷
│ Warning: Provider development overrides are in effect
│
│ The following provider development overrides are set in the CLI configuration:
│   - couchbasecloud/couchbase-capella in /Users/$USER/GolandProjects/terraform-provider-couchbase-capella/bin
│
│ The behavior may therefore not match any released version of the provider and applying changes may cause the state to become incompatible with published releases.
╵
data.couchbase-capella_gcp_private_endpoint_command.gcp_command: Reading...
data.couchbase-capella_gcp_private_endpoint_command.gcp_command: Read complete after 1s

Changes to Outputs:
  + gcp_command = {
      + cluster_id      = "b6576f48-2cf1-4589-812e-9655664362f4"
      + command         = <<-EOT
          #!/bin/bash
          REGION='us-east1'
          NETWORK='psc-test'
          SUBNET='psc-test-1'
          CLUSTER='b6576f48-2cf1-4589-812e-9655664362f4'
          BASE_DNS_NAME='n-b2yhxoydjdec9j.aws-guardians.nonprod-project-avengers.com'
          SERVICE_ATTACHMENT='projects/cbc-dev-bbf356999fa41d60/regions/us-east1/serviceAttachments/psc-b6576f48-2cf1-4589-812e-9655664362f4'
          BOOTSTRAP_SERVICE='projects/cbc-dev-bbf356999fa41d60/regions/us-east1/serviceAttachments/psc-bootstrap-b6576f48-2cf1-4589-812e-9655664362f4'

          NETWORK_SHORT=${NETWORK:0:15}
          CLUSTER_SHORT=${CLUSTER:0:15}

          # Create private DNS zone
          gcloud dns managed-zones create $NETWORK_SHORT-$CLUSTER_SHORT --description="Private Endpoint for Capella cluster" --dns-name=$BASE_DNS_NAME --networks=$NETWORK --visibility=private
          gcloud dns record-sets transaction start --zone=$NETWORK_SHORT-$CLUSTER_SHORT

          # Create forwarding rule for main service
          gcloud compute addresses create pe-address-$NETWORK_SHORT-$CLUSTER_SHORT --region=$REGION --subnet=$SUBNET
          IP_ADDRESS=$(gcloud compute addresses list --filter="name=pe-address-$NETWORK_SHORT-$CLUSTER_SHORT AND region:$REGION AND subnetwork:$SUBNET" --format="value(address)")
          gcloud compute forwarding-rules create endpoint-$NETWORK_SHORT-$CLUSTER_SHORT --region=$REGION --network=$NETWORK --address=pe-address-$NETWORK_SHORT-$CLUSTER_SHORT --target-service-attachment=$SERVICE_ATTACHMENT
          gcloud dns record-sets transaction add $IP_ADDRESS --name=pe.$BASE_DNS_NAME --type=A --ttl=300 --zone=$NETWORK_SHORT-$CLUSTER_SHORT

          # Create forwarding rule for bootstrap service
          gcloud compute addresses create pe-address-bootstrap-$NETWORK_SHORT-$CLUSTER_SHORT --region=$REGION --subnet=$SUBNET
          IP_ADDRESS=$(gcloud compute addresses list --filter="name=pe-address-bootstrap-$NETWORK_SHORT-$CLUSTER_SHORT AND region:$REGION AND subnetwork:$SUBNET" --format="value(address)")
          gcloud compute forwarding-rules create endpoint-bootstrap-$NETWORK_SHORT-$CLUSTER_SHORT --region=$REGION --network=$NETWORK --address=pe-address-bootstrap-$NETWORK_SHORT-$CLUSTER_SHORT --target-service-attachment=$BOOTSTRAP_SERVICE
          gcloud dns record-sets transaction add $IP_ADDRESS --name=private-endpoint.$BASE_DNS_NAME --type=A --ttl=300 --zone=$NETWORK_SHORT-$CLUSTER_SHORT

          # Execute DNS transaction
          gcloud dns record-sets transaction execute --zone=$NETWORK_SHORT-$CLUSTER_SHORT
        EOT
      + organization_id = "ffffffff-aaaa-1414-eeee-000000000000"
      + project_id      = "ffffffff-aaaa-1414-eeee-000000000000"
      + subnet_ids      = [
          + "psc-test-1",
        ]
      + vpc_network_id = "psc-test"
    }

You can apply this plan to save these new output values to the Terraform state, without changing any real infrastructure.

Do you want to perform these actions?
  Terraform will perform the actions described above.
  Only 'yes' will be accepted to approve.

  Enter a value: yes
```

---

## Notes

- This script is only compatible with BASH-like shells.
- Ensure that `gcloud` CLI is installed and authenticated prior to running the command.
- DNS zone and forwarding rule names are derived from the VPC and cluster IDs.
- Ensure GCP IAM permissions allow creation of forwarding rules and DNS zones.